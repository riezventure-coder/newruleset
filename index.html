<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>CRM + ID PORT + SVLAN</title>
<style>
body { font-family: Arial; padding: 20px }
textarea { width: 100%; height: 120px }
input { padding: 5px; margin: 5px }
button { padding: 10px; margin-top: 10px }
table { border-collapse: collapse; margin-top: 20px }
td, th { border: 1px solid #000; padding: 6px }
</style>
</head>
<body>

<h2>CRM + ID PORT + SVLAN (Google Sheets)</h2>

<textarea id="crmText" placeholder="Paste text CRM di sini"></textarea>

<br>
IP: <input id="ip">
SLOT: <input id="slot">
PORT: <input id="port">

<br>
<button onclick="processData()">PROSES</button>

<table id="result">
<tr>
<th>Service</th>
<th>Service ID</th>
<th>ID PORT</th>
<th>SVLAN</th>
</tr>
</table>

<script>
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTUzTtaRANBaWfV3cnPwGxMxdI4ZYePm3IgBsVQ8t6Ho8rBZEPU3O-ZpqdK5sQYbXHqBsaClqtzk-0y/pub?gid=0&single=true&output=csv";

async function processData() {
  const crm = document.getElementById("crmText").value;
  const ip = document.getElementById("ip").value;
  const slot = document.getElementById("slot").value;
  const port = document.getElementById("port").value;

  // Ambil Service ID dari CRM
  const services = crm.match(/1-[A-Z0-9_]+_(INTERNET|VOICE|IPTV)/g) || [];

  // Load Google Sheets
  const res = await fetch(SHEET_URL);
  const text = await res.text();
  const rows = text.split("\n").map(r => r.split(","));

  const header = rows[0];
  const data = rows.slice(1);

  const idx = {
    IP: header.indexOf("IP"),
    SLOT: header.indexOf("SLOT"),
    PORT: header.indexOf("PORT"),
    VLAN: header.indexOf("VLAN"),
    ID_PORT: header.indexOf("ID_PORT")
  };

  const match = data.find(r =>
    r[idx.IP] == ip &&
    r[idx.SLOT] == slot &&
    r[idx.PORT] == port
  );

  if (!match) {
    alert("Data OLT tidak ditemukan");
    return;
  }

  const [svlanInternet, svlanVoice] = (match[idx.VLAN] || "").split(",");

  const table = document.getElementById("result");
  table.innerHTML = `
    <tr>
      <th>Service</th>
      <th>Service ID</th>
      <th>ID PORT</th>
      <th>SVLAN</th>
    </tr>
  `;

  services.forEach(s => {
    let vlan = "";
    if (s.includes("INTERNET")) vlan = svlanInternet || "";
    if (s.includes("VOICE")) vlan = svlanVoice || "";
    if (s.includes("IPTV")) vlan = "";

    table.innerHTML += `
      <tr>
        <td>${s.split("_").pop()}</td>
        <td>${s}</td>
        <td>${match[idx.ID_PORT]}</td>
        <td>${vlan}</td>
      </tr>
    `;
  });
}
</script>

</body>
</html>
