<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>CRM Ruleset Generator (Final)</title>
<style>
  body { font-family: Arial; padding: 20px; }
  textarea { width: 100%; height: 120px; margin-bottom: 8px; }
  input { padding: 6px; margin: 6px 0; width: calc(33% - 8px); }
  button { padding: 10px 16px; margin-top: 10px; }
  table { border-collapse: collapse; margin-top: 20px; width: 100%; }
  th, td { border: 1px solid #000; padding: 8px; text-align: left; }
  th { background-color: #ddd; }
</style>
</head>
<body>

<h2>CRM Ruleset Generator</h2>

<label><strong>Paste Text CRM:</strong></label><br>
<textarea id="crmText" placeholder="Paste text CRM di sini"></textarea><br>

<label><strong>Input IP / SLOT / PORT:</strong></label><br>
<input id="ip" placeholder="Contoh: 172.24.155.4">
<input id="slot" placeholder="Contoh: 1">
<input id="port" placeholder="Contoh: 0">

<br>
<button onclick="generateRuleset()">GENERATE</button>

<table id="resultTable">
  <tr>
    <th>RESOURCE_ID</th>
    <th>SERVICE_NAME</th>
    <th>TARGET_ID</th>
    <th>CONFIG_ITEM_NAME</th>
  </tr>
</table>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzP8jhWWGpt8QygEx29yvMhVHh1L6iqxFCW90N5vUyNVFcSYgEZjm2eAbRPFRqXjGcq/exec";

function generateRuleset() {
  const crmText = document.getElementById("crmText").value.trim();
  const ip = document.getElementById("ip").value.trim();
  const slot = document.getElementById("slot").value.trim();
  const port = document.getElementById("port").value.trim();
  const table = document.getElementById("resultTable");

  if (!crmText || !ip || !slot || !port) {
    alert("Lengkapi semua input (CRM, IP, SLOT, PORT).");
    return;
  }

  // Deteksi layanan dari CRM
  const services = {
    INTERNET: crmText.includes("_INTERNET"),
    VOICE: crmText.includes("_VOICE"),
    IPTV: crmText.includes("_IPTV")
  };

  // Fetch data dari Google Apps Script API
  fetch(API_URL)
    .then(res => res.json())
    .then(data => {
      // Masing-masing baris = array nilai per kolom
      // data[0] = header row
      const rows = data.slice(1); // skip header

      // Cari baris yang sesuai IP, SLOT, PORT
      const match = rows.find(r =>
        r[0]?.toString().trim() === ip &&
        r[1]?.toString().trim() === slot &&
        r[2]?.toString().trim() === port
      );

      if (!match) {
        alert("Data OLT tidak ditemukan di Google Sheet.");
        return;
      }

      // Ambil ID_PORT dan VLAN
      const idPort = match[4]?.toString().trim() || "";
      const vlanRaw = match[3]?.toString().trim() || "";
      const vlanParts = vlanRaw.split(",").map(v => v.trim());

      const svlanInternet = vlanParts[0] || "";
      const svlanVoice = vlanParts[1] || "";

      // Reset tabel
      table.innerHTML = `
        <tr>
          <th>RESOURCE_ID</th>
          <th>SERVICE_NAME</th>
          <th>TARGET_ID</th>
          <th>CONFIG_ITEM_NAME</th>
        </tr>
      `;

      // INTERNET
      if (services.INTERNET) {
        table.innerHTML += `
          <tr><td>${idPort}</td><td>INTERNET</td><td></td><td>Service_Port</td></tr>
        `;
        if (svlanInternet) {
          table.innerHTML += `
            <tr><td>${svlanInternet}</td><td>INTERNET</td><td></td><td>S-Vlan</td></tr>
          `;
        }
      }

      // VOICE
      if (services.VOICE) {
        table.innerHTML += `
          <tr><td>${idPort}</td><td>VOICE</td><td></td><td>Service_Port</td></tr>
        `;
        if (svlanVoice) {
          table.innerHTML += `
            <tr><td>${svlanVoice}</td><td>VOICE</td><td></td><td>S-Vlan</td></tr>
          `;
        }
      }

      // IPTV
      if (services.IPTV) {
        table.innerHTML += `
          <tr><td>${idPort}</td><td>IPTV</td><td></td><td>Service_Port</td></tr>
        `;
      }

    }).catch(err => {
      console.error(err);
      alert("Gagal memuat data dari Google Sheet API.");
    });
}
</script>

</body>
</html>
