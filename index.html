<script>
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTUzTtaRANBaWfV3cnPwGxMxdI4ZYePm3IgBsVQ8t6Ho8rBZEPU3O-ZpqdK5sQYbXHqBsaClqtzk-0y/pub?gid=0&single=true&output=csv";

async function processData() {
  const crmText = document.getElementById("crmText").value;
  const ip = document.getElementById("ip").value.trim();
  const slot = document.getElementById("slot").value.trim();
  const port = document.getElementById("port").value.trim();

  // === AMBIL SERVICE ID CRM ===
  const serviceMap = {
    INTERNET: "",
    VOICE: "",
    IPTV: ""
  };

  const regex = /1-[A-Z0-9_]+_(INTERNET|VOICE|IPTV)/g;
  let match;
  while ((match = regex.exec(crmText)) !== null) {
    serviceMap[match[1]] = match[0];
  }

  // === LOAD GOOGLE SHEETS ===
  const res = await fetch(SHEET_URL);
  const csv = await res.text();

  const rows = csv
    .trim()
    .split("\n")
    .map(r => r.replace("\r", "").split(",").map(c => c.trim()));

  const header = rows[0];
  const data = rows.slice(1);

  const idx = {
    IP: header.indexOf("IP"),
    SLOT: header.indexOf("SLOT"),
    PORT: header.indexOf("PORT"),
    VLAN: header.indexOf("VLAN"),
    ID_PORT: header.indexOf("ID_PORT")
  };

  const olt = data.find(r =>
    r[idx.IP] === ip &&
    r[idx.SLOT] === slot &&
    r[idx.PORT] === port
  );

  if (!olt) {
    alert("Data OLT tidak ditemukan");
    return;
  }

  const vlanRaw = olt[idx.VLAN] || "";
  const [svlanInternet, svlanVoice] = vlanRaw.split(",").map(v => v?.trim() || "");

  // === OUTPUT TABLE ===
  const table = document.getElementById("result");
  table.innerHTML = `
    <tr>
      <th>SERVICE</th>
      <th>SERVICE_ID</th>
      <th>ID_PORT</th>
      <th>SVLAN</th>
    </tr>
  `;

  const output = [
    ["INTERNET", serviceMap.INTERNET, olt[idx.ID_PORT], svlanInternet],
    ["VOICE", serviceMap.VOICE, olt[idx.ID_PORT], svlanVoice],
    ["IPTV", serviceMap.IPTV, olt[idx.ID_PORT], ""]
  ];

  output.forEach(row => {
    if (!row[1]) return;
    table.innerHTML += `
      <tr>
        <td>${row[0]}</td>
        <td>${row[1]}</td>
        <td>${row[2]}</td>
        <td>${row[3]}</td>
      </tr>
    `;
  });
}
</script>
