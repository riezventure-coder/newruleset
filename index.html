<script>
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTUzTtaRANBaWfV3cnPwGxMxdI4ZYePm3IgBsVQ8t6Ho8rBZEPU3O-ZpqdK5sQYbXHqBsaClqtzk-0y/pub?gid=0&single=true&output=csv";

function clean(val) {
  return val ? val.replace(/^"+|"+$/g, "").trim() : "";
}

async function processData() {
  try {
    const crmText = document.getElementById("crmText").value;
    const ip = document.getElementById("ip").value.trim();
    const slot = document.getElementById("slot").value.trim();
    const port = document.getElementById("port").value.trim();

    // === DETEKSI SERVICE ===
    const services = { INTERNET:false, VOICE:false, IPTV:false };
    const regex = /1-[A-Z0-9_]+_(INTERNET|VOICE|IPTV)/g;
    let m;
    while ((m = regex.exec(crmText)) !== null) {
      services[m[1]] = true;
    }

    // === LOAD GOOGLE SHEETS ===
    const res = await fetch(SHEET_URL);
    if (!res.ok) throw new Error("Gagal load Google Sheets");

    const csv = await res.text();
    const rows = csv
      .trim()
      .split("\n")
      .map(r => r.replace("\r","").split(",").map(clean));

    const header = rows[0];
    const data = rows.slice(1);

    const idx = {
      IP: header.indexOf("IP"),
      SLOT: header.indexOf("SLOT"),
      PORT: header.indexOf("PORT"),
      VLAN: header.indexOf("VLAN"),
      ID_PORT: header.indexOf("ID_PORT")
    };

    const olt = data.find(r =>
      r[idx.IP] === ip &&
      r[idx.SLOT] === slot &&
      r[idx.PORT] === port
    );

    if (!olt) {
      alert("Data OLT tidak ditemukan");
      return;
    }

    const idPort = olt[idx.ID_PORT]; // â¬… FIX: ini sekarang benar
    const [svlanInternet, svlanVoice] =
      (olt[idx.VLAN] || "").split(",").map(clean);

    const table = document.getElementById("result");
    table.innerHTML = `
      <tr>
        <th>RESOURCE_ID</th>
        <th>SERVICE_NAME</th>
        <th>TARGET_ID</th>
        <th>CONFIG_ITEM_NAME</th>
      </tr>
    `;

    // INTERNET
    if (services.INTERNET) {
      table.innerHTML += `
        <tr><td>${idPort}</td><td>INTERNET</td><td></td><td>Service_Port</td></tr>
      `;
      if (svlanInternet) {
        table.innerHTML += `
          <tr><td>${svlanInternet}</td><td>INTERNET</td><td></td><td>S-Vlan</td></tr>
        `;
      }
    }

    // VOICE
    if (services.VOICE) {
      table.innerHTML += `
        <tr><td>${idPort}</td><td>VOICE</td><td></td><td>Service_Port</td></tr>
      `;
      if (svlanVoice) {
        table.innerHTML += `
          <tr><td>${svlanVoice}</td><td>VOICE</td><td></td><td>S-Vlan</td></tr>
        `;
      }
    }

    // IPTV
    if (services.IPTV) {
      table.innerHTML += `
        <tr><td>${idPort}</td><td>IPTV</td><td></td><td>Service_Port</td></tr>
      `;
    }

  } catch (err) {
    alert("ERROR: " + err.message);
    console.error(err);
  }
}
</script>
