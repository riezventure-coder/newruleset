<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Ruleset Generator</title>
<style>
body { font-family: Arial; padding:20px }
textarea { width:100%; height:120px }
input { padding:6px; margin:5px }
button { padding:8px 16px }
table { border-collapse:collapse; margin-top:20px }
th,td { border:1px solid #000; padding:6px }
</style>
</head>
<body>

<h2>Ruleset Generator (CRM + Google Sheets CSV)</h2>

<textarea id="crm" placeholder="Paste text CRM di sini"></textarea><br>

IP <input id="ip" placeholder="172.24.155.4">
SLOT <input id="slot" placeholder="1">
PORT <input id="port" placeholder="0">
<button onclick="proses()">PROSES</button>

<table id="out">
<tr>
<th>RESOURCE_ID</th>
<th>SERVICE_NAME</th>
<th>TARGET_ID</th>
<th>CONFIG_ITEM_NAME</th>
</tr>
</table>

<script>
const CSV_URL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vTUzTtaRANBaWfV3cnPwGxMxdI4ZYePm3IgBsVQ8t6Ho8rBZEPU3O-ZpqdK5sQYbXHqBsaClqtzk-0y/pub?output=csv";

function proses() {
  const crm = document.getElementById("crm").value;
  const ip = document.getElementById("ip").value.trim();
  const slot = document.getElementById("slot").value.trim();
  const port = document.getElementById("port").value.trim();

  if (!crm || !ip || !slot || !port) {
    alert("Lengkapi semua input");
    return;
  }

  const service = {
    INTERNET: crm.includes("_INTERNET"),
    VOICE: crm.includes("_VOICE"),
    IPTV: crm.includes("_IPTV")
  };

  fetch(CSV_URL)
    .then(r => r.text())
    .then(csv => {
      const lines = csv.trim().split("\n");
      const data = lines.slice(1).map(l =>
        l.split(",").map(x => x.trim())
      );

      const row = data.find(r =>
        r[0] === ip &&
        r[1] === slot &&
        r[2] === port
      );

      if (!row) {
        alert("DATA IP / SLOT / PORT TIDAK DITEMUKAN");
        return;
      }

      const vlanArr = row[3].split(",");
      const idPort = row[4];

      const svlanInternet = vlanArr[0]?.trim();
      const svlanVoice = vlanArr[1]?.trim();

      const tbl = document.getElementById("out");
      tbl.innerHTML = `
      <tr>
        <th>RESOURCE_ID</th>
        <th>SERVICE_NAME</th>
        <th>TARGET_ID</th>
        <th>CONFIG_ITEM_NAME</th>
      </tr>`;

      if (service.INTERNET) {
        tbl.innerHTML += `
          <tr><td>${idPort}</td><td>INTERNET</td><td></td><td>Service_Port</td></tr>
          <tr><td>${svlanInternet}</td><td>INTERNET</td><td></td><td>S-Vlan</td></tr>`;
      }

      if (service.VOICE) {
        tbl.innerHTML += `
          <tr><td>${idPort}</td><td>VOICE</td><td></td><td>Service_Port</td></tr>
          <tr><td>${svlanVoice}</td><td>VOICE</td><td></td><td>S-Vlan</td></tr>`;
      }

      if (service.IPTV) {
        tbl.innerHTML += `
          <tr><td>${idPort}</td><td>IPTV</td><td></td><td>Service_Port</td></tr>`;
      }
    })
    .catch(err => {
      alert("Gagal load CSV Google Sheet");
      console.error(err);
    });
}
</script>

</body>
</html>
