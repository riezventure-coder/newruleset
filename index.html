<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Ruleset Generator</title>
<style>
body { font-family: Arial; padding: 20px }
textarea { width: 100%; height: 120px }
input { margin: 5px; padding: 5px }
button { padding: 10px; margin-top: 10px }
table { border-collapse: collapse; margin-top: 20px }
th, td { border: 1px solid #000; padding: 6px }
</style>
</head>
<body>

<h2>Ruleset Generator (CRM + Google Sheets)</h2>

<textarea id="crmText" placeholder="Paste text CRM di sini"></textarea>

<br>
IP <input id="ip">
SLOT <input id="slot">
PORT <input id="port">

<br>
<button onclick="processData()">PROSES</button>

<table id="result">
  <tr>
    <th>RESOURCE_ID</th>
    <th>SERVICE_NAME</th>
    <th>TARGET_ID</th>
    <th>CONFIG_ITEM_NAME</th>
  </tr>
</table>

<script>
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTUzTtaRANBaWfV3cnPwGxMxdI4ZYePm3IgBsVQ8t6Ho8rBZEPU3O-ZpqdK5sQYbXHqBsaClqtzk-0y/pub?gid=0&single=true&output=csv";

async function processData() {
  try {
    const crmText = document.getElementById("crmText").value;
    const ip = document.getElementById("ip").value.trim();
    const slot = document.getElementById("slot").value.trim();
    const port = document.getElementById("port").value.trim();

    // === DETEKSI SERVICE ===
    const services = { INTERNET:false, VOICE:false, IPTV:false };
    const regex = /1-[A-Z0-9_]+_(INTERNET|VOICE|IPTV)/g;
    let m;
    while ((m = regex.exec(crmText)) !== null) {
      services[m[1]] = true;
    }

    // === FETCH GOOGLE SHEETS ===
    const res = await fetch(SHEET_URL);
    if (!res.ok) throw new Error("Gagal load Google Sheets");

    const csv = await res.text();
    const rows = csv.trim().split("\n").map(r =>
      r.replace("\r","").split(",").map(c => c.trim())
    );

    const header = rows[0];
    const data = rows.slice(1);

    const idx = {
      IP: header.indexOf("IP"),
      SLOT: header.indexOf("SLOT"),
      PORT: header.indexOf("PORT"),
      ID_PORT: header.indexOf("ID_PORT")
    };

    const olt = data.find(r =>
      r[idx.IP] === ip &&
      r[idx.SLOT] === slot &&
      r[idx.PORT] === port
    );

    if (!olt) {
      alert("Data OLT tidak ditemukan");
      return;
    }

    const table = document.getElementById("result");
    table.innerHTML = `
      <tr>
        <th>RESOURCE_ID</th>
        <th>SERVICE_NAME</th>
        <th>TARGET_ID</th>
        <th>CONFIG_ITEM_NAME</th>
      </tr>
    `;

    ["INTERNET","VOICE","IPTV"].forEach(service => {
      if (!services[service]) return;

      // Service_Port
      table.innerHTML += `
        <tr>
          <td>${olt[idx.ID_PORT]}</td>
          <td>${service}</td>
          <td></td>
          <td>Service_Port</td>
        </tr>
      `;

      // S-Vlan hanya Internet & Voice
      if (service !== "IPTV") {
        table.innerHTML += `
          <tr>
            <td>${olt[idx.ID_PORT]}</td>
            <td>${service}</td>
            <td></td>
            <td>S-Vlan</td>
          </tr>
        `;
      }
    });

  } catch (err) {
    alert("ERROR: " + err.message);
    console.error(err);
  }
}
</script>

</body>
</html>
