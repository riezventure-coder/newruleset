<script>
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTUzTtaRANBaWfV3cnPwGxMxdI4ZYePm3IgBsVQ8t6Ho8rBZEPU3O-ZpqdK5sQYbXHqBsaClqtzk-0y/pub?gid=0&single=true&output=csv";

async function processData() {
  const crmText = document.getElementById("crmText").value;
  const ip = document.getElementById("ip").value.trim();
  const slot = document.getElementById("slot").value.trim();
  const port = document.getElementById("port").value.trim();

  // === DETEKSI SERVICE DARI CRM ===
  const services = {
    INTERNET: false,
    VOICE: false,
    IPTV: false
  };

  const regex = /1-[A-Z0-9_]+_(INTERNET|VOICE|IPTV)/g;
  let m;
  while ((m = regex.exec(crmText)) !== null) {
    services[m[1]] = true;
  }

  // === LOAD GOOGLE SHEETS ===
  const res = await fetch(SHEET_URL);
  const csv = await res.text();

  const rows = csv
    .trim()
    .split("\n")
    .map(r => r.replace("\r", "").split(",").map(c => c.trim()));

  const header = rows[0];
  const data = rows.slice(1);

  const idx = {
    IP: header.indexOf("IP"),
    SLOT: header.indexOf("SLOT"),
    PORT: header.indexOf("PORT"),
    ID_PORT: header.indexOf("ID_PORT")
  };

  const olt = data.find(r =>
    r[idx.IP] === ip &&
    r[idx.SLOT] === slot &&
    r[idx.PORT] === port
  );

  if (!olt) {
    alert("Data OLT tidak ditemukan");
    return;
  }

  // === OUTPUT TABLE ===
  const table = document.getElementById("result");
  table.innerHTML = `
    <tr>
      <th>RESOURCE_ID</th>
      <th>SERVICE_NAME</th>
      <th>TARGET_ID</th>
      <th>CONFIG_ITEM_NAME</th>
    </tr>
  `;

  ["INTERNET", "VOICE", "IPTV"].forEach(service => {
    if (!services[service]) return;

    // Service_Port (selalu ada)
    table.innerHTML += `
      <tr>
        <td>${olt[idx.ID_PORT]}</td>
        <td>${service}</td>
        <td></td>
        <td>Service_Port</td>
      </tr>
    `;

    // S-Vlan (hanya Internet & Voice)
    if (service === "INTERNET" || service === "VOICE") {
      table.innerHTML += `
        <tr>
          <td>${olt[idx.ID_PORT]}</td>
          <td>${service}</td>
          <td></td>
          <td>S-Vlan</td>
        </tr>
      `;
    }
  });
}
</script>
