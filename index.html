<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Auto Rule Generator</title>
<style>
body { font-family: Arial; padding: 20px; }
textarea, input { width: 100%; margin-bottom: 10px; padding: 8px; }
button { padding: 10px 16px; margin: 5px 0; cursor: pointer; }
table { border-collapse: collapse; width: 100%; margin-top: 20px; }
th, td { border: 1px solid #000; padding: 6px; text-align: left; }
th { background: #eee; }
</style>
</head>
<body>

<h2>Auto Rule Generator</h2>

<label>Text CRM</label>
<textarea id="crm" rows="6"></textarea>

<label>IP</label>
<input id="ip">

<label>SLOT</label>
<input id="slot">

<label>PORT</label>
<input id="port">

<button onclick="generate()">Generate</button>
<button onclick="copyTable()">ðŸ“‹ Copy Output</button>

<table id="result">
<thead>
<tr>
<th>RESOURCE_ID</th>
<th>SERVICE_NAME</th>
<th>TARGET_ID</th>
<th>CONFIG_ITEM_NAME</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
const SHEET_URL = "https://script.google.com/macros/s/AKfycbzP8jhWWGpt8QygEx29yvMhVHh1L6iqxFCW90N5vUyNVFcSYgEZjm2eAbRPFRqXjGcq/exec";

let sheetData = [];

fetch(SHEET_URL)
  .then(res => res.json())
  .then(data => sheetData = data)
  .catch(() => alert("ERROR load Google Sheet"));

function generate() {
  const crm = document.getElementById("crm").value;
  const ip = document.getElementById("ip").value.trim();
  const slot = document.getElementById("slot").value.trim();
  const port = document.getElementById("port").value.trim();
  const tbody = document.querySelector("#result tbody");

  tbody.innerHTML = "";

  if (!crm || !ip || !slot || !port) {
    alert("Data belum lengkap");
    return;
  }

 const row = sheetData.find(r =>
  String(r.IP).trim() === ip &&
  String(r.SLOT).trim() === slot &&
  String(r.PORT).trim() === port
);

  if (!row) {
    alert("Data PORT tidak ditemukan");
    return;
  }

  const idPort = row.ID_PORT;
  const vlans = row.VLAN.split(",").map(v => v.trim());
  const svlanInternet = vlans[0] || "";
  const svlanVoice = vlans[1] || "";

  // Ambil SERVICE_NAME dari CRM (fleksibel)
  const serviceIds = crm.match(/[\w-]+_(INTERNET|VOICE|IPTV)/g) || [];

  serviceIds.forEach(service => {
    const type =
      service.endsWith("_INTERNET") ? "INTERNET" :
      service.endsWith("_VOICE") ? "VOICE" :
      "IPTV";

    // Service_Port
    tbody.innerHTML += `
      <tr>
        <td>${idPort}</td>
        <td>${service}</td>
        <td></td>
        <td>Service_Port</td>
      </tr>
    `;

    // S-VLAN
    if (type === "INTERNET" && svlanInternet) {
      tbody.innerHTML += `
        <tr>
          <td>${svlanInternet}</td>
          <td>${service}</td>
          <td></td>
          <td>S-Vlan</td>
        </tr>
      `;
    }

    if (type === "VOICE" && svlanVoice) {
      tbody.innerHTML += `
        <tr>
          <td>${svlanVoice}</td>
          <td>${service}</td>
          <td></td>
          <td>S-Vlan</td>
        </tr>
      `;
    }
  });
}

function copyTable() {
  let text = "";
  document.querySelectorAll("#result tr").forEach((row, i) => {
    if (i === 0) return;
    text += [...row.children].map(td => td.innerText).join("\t") + "\n";
  });
  navigator.clipboard.writeText(text);
  alert("Copied! Tinggal paste ke Excel");
}
</script>

</body>
</html>

